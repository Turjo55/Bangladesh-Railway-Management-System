<%- include('../partials/header') %>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-white sidebar collapse shadow-sm">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="/admin/dashboard"><i
                                    class="fas fa-home me-2"></i> Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/bookings"><i
                                    class="fas fa-ticket-alt me-2"></i> Booking Manager</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/admin/routes"><i
                                    class="fas fa-route me-2"></i> Train Route Manager</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users"><i class="fas fa-users me-2"></i>
                                User Manager</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/reports"><i
                                    class="fas fa-chart-line me-2"></i> Reports</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings"><i class="fas fa-cog me-2"></i>
                                Settings</a></li>
                    </ul>
                </div>
            </nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 my-4">
                <h2 class="mb-4">Train Route Manager</h2>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <!-- ADD NEW ROUTE BUTTON (Triggers Modal) -->
                        <button class="btn btn-success mb-3" data-mdb-toggle="modal" data-mdb-target="#addRouteModal">
                            <i class="fas fa-plus"></i> Add New Route
                        </button>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Train Code</th>
                                        <th>Route</th>
                                        <th>Schedule</th>
                                        <th>Fares (S_Chair)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (routes && routes.length> 0) { %>
                                        <% routes.forEach(r=> { %>
                                            <tr>
                                                <td class="fw-bold">
                                                    <%= r.train_code %>
                                                </td>
                                                <td>
                                                    <%= r.from_station %> <i
                                                            class="fas fa-arrow-right text-muted mx-1"></i>
                                                        <%= r.to_station %>
                                                </td>
                                                <td>
                                                    Dep: <%= r.departure_time %><br>
                                                        Arr: <%= r.arrival_time %>
                                                </td>
                                                <td>à§³ <%= r.fare_shovan %>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" data-mdb-toggle="modal"
                                                        data-mdb-target="#interiorModal">
                                                        <i class="fas fa-eye"></i> Interior
                                                    </button>
                                                    <!-- EDIT BUTTON (Triggers Modal & Populates Data) -->
                                                    <button class="btn btn-sm btn-primary edit-route-btn"
                                                        data-id="<%= r._id %>" data-code="<%= r.train_code %>"
                                                        data-from="<%= r.from_station %>" data-to="<%= r.to_station %>"
                                                        data-dep="<%= r.departure_time %>"
                                                        data-arr="<%= r.arrival_time %>"
                                                        data-fare="<%= r.fare_shovan %>" data-mdb-toggle="modal"
                                                        data-mdb-target="#editRouteModal">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <a href="/admin/routes/delete/<%= r._id %>"
                                                        class="btn btn-sm btn-danger"
                                                        onclick="return confirm('Are you sure?')">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="5" class="text-center text-muted">No routes found.
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div class="modal fade" id="addRouteModal" tabindex="-1" aria-labelledby="addRouteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/admin/routes/add" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addRouteModalLabel">Add New Route</h5>
                        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Train Code</label>
                            <input type="text" class="form-control" name="train_code" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">From Station</label>
                                <input type="text" class="form-control" name="from_station" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">To Station</label>
                                <input type="text" class="form-control" name="to_station" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Departure Time</label>
                                <input type="time" class="form-control" name="departure_time" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Arrival Time</label>
                                <input type="time" class="form-control" name="arrival_time" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fare (Shovan Chair)</label>
                            <input type="number" class="form-control" name="fare_shovan" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Save Route</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Route Modal -->
    <div class="modal fade" id="editRouteModal" tabindex="-1" aria-labelledby="editRouteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editRouteForm" action="/admin/routes/edit" method="POST">
                    <input type="hidden" name="id" id="edit_id">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editRouteModalLabel">Edit Route</h5>
                        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Train Code</label>
                            <input type="text" class="form-control" name="train_code" id="edit_code" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">From Station</label>
                                <input type="text" class="form-control" name="from_station" id="edit_from" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">To Station</label>
                                <input type="text" class="form-control" name="to_station" id="edit_to" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Departure Time</label>
                                <input type="text" class="form-control" name="departure_time" id="edit_dep" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Arrival Time</label>
                                <input type="text" class="form-control" name="arrival_time" id="edit_arr" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fare (Shovan Chair)</label>
                            <input type="number" class="form-control" name="fare_shovan" id="edit_fare" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Route</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Interior Modal -->
    <div class="modal fade" id="interiorModal" tabindex="-1" aria-labelledby="interiorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="interiorModalLabel">Train Interior View</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/23/Interior_of_a_Shovon_Chair_coach_on_Subarna_Express.jpg"
                        class="img-fluid rounded shadow-sm" alt="Train Interior">
                    <h5 class="mt-3">Shovon Chair Class</h5>
                    <p class="text-muted">Standard seating arrangement for Intercity trains.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

        <script>
            // Edit Button Script to Populate Modal
            document.addEventListener('DOMContentLoaded', () => {
                const editButtons = document.querySelectorAll('.edit-route-btn');
                editButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const code = btn.getAttribute('data-code');
                        const from = btn.getAttribute('data-from');
                        const to = btn.getAttribute('data-to');
                        const dep = btn.getAttribute('data-dep');
                        const arr = btn.getAttribute('data-arr');
                        const fare = btn.getAttribute('data-fare');

                        document.getElementById('edit_id').value = id;
                        document.getElementById('edit_code').value = code;
                        document.getElementById('edit_from').value = from;
                        document.getElementById('edit_to').value = to;
                        document.getElementById('edit_dep').value = dep;
                        document.getElementById('edit_arr').value = arr;
                        document.getElementById('edit_fare').value = fare;

                        // Update Form Action
                        document.getElementById('editRouteForm').action = `/admin/routes/edit/${id}`;
                    });
                });
            });
        </script>